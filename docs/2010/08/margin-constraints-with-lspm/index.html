<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Margin Constraints with LSPM - FOSS Trading</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Margin Constraints with LSPM" />
<meta property="og:description" content="When optimizing leverage space portfolios, I frequently run into the issue of one or more f$ ([Max Loss]/f) being less than the margin of its respective instrument. For example, assume the required margin for an instrument is $500, f$ is $100, and $100,000 in equity. The optimal amount to trade is 1,000 shares ($100,000/$100). However, that would require $500,000 in equity, while you only have $100,000. What do you do?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.fosstrading.com/2010/08/margin-constraints-with-lspm/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2010-08-01T23:31:00-05:00" />
<meta property="article:modified_time" content="2010-08-01T23:31:00-05:00" />

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/fosstrading.css"><link rel="stylesheet" href="/syntax.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LT26X44HDL"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LT26X44HDL', { 'anonymize_ip': false });
}
</script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="FOSS Trading" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">FOSS Trading</div>
					<div class="logo__tagline">Algorithmic Trading with Free Open Source Software</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Blog</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/page/disclosures/">
				
				<span class="menu__text">Disclosures</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/page/enterprise/">
				
				<span class="menu__text">For Enterprise</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Margin Constraints with LSPM</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2010-08-01T23:31:00-05:00">August 01, 2010</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/Articles/" rel="category">Articles</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p>When optimizing leverage space portfolios, I frequently run into the issue of one or more f$ ([Max Loss]/f) being less than the margin of its respective instrument.  For example, assume the required margin for an instrument is $500, f$ is $100, and $100,000 in equity.  The optimal amount to trade is 1,000 shares ($100,000/$100).  However, that would require $500,000 in equity, while you only have $100,000.  What do you do?</p>
<p>Page 341 of <a href="http://www.amazon.com/gp/product/0471757683?ie=UTF8&amp;tag=fosstrading-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0471757683">The Handbook of Portfolio Mathematics</a> outlines how to determine how many units to trade, given margin constraints.  The methodology therein suggests finding optimal f values first, then calculating the portfolio that satisfies the margin constraints but keeps the ratio of each market system to one another the same.</p>
<p>For those without the book, the calculation is:<br>
L = max(f$) / sum( ( max(f$) / f$[i] ) * margin[i] )</p>
<p>Where:<br>
L = percentage of &ldquo;active equity&rdquo; to use when dividing by each f$<br>
margin = initial margin for each market system</p>
<p>The <code>maxUnits()</code> function included in this post uses the formula above to return the maximum number of tradeable units.  In this example, we assume our margin is equal to our maximum loss (as is the case with equities).  The code below illustrates how to use the <code>maxUnits()</code> function after optimization.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Load the LSPM package</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">LSPM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">maxUnits</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">lsp</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">equity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Make sure margin and f are same length</span>
</span></span><span class="line"><span class="cl">  <span class="n">NRf</span> <span class="o">&lt;-</span> <span class="nf">NROW</span><span class="p">(</span><span class="n">lsp</span><span class="o">$</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nf">if</span><span class="p">(</span><span class="nf">NROW</span><span class="p">(</span><span class="n">margin</span><span class="p">)</span><span class="o">!=</span><span class="n">NRf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">stop</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&#34;&#39;margin&#39; must have length =&#34;</span><span class="p">,</span><span class="n">NRf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Calculate maximum equity percentage</span>
</span></span><span class="line"><span class="cl">  <span class="n">fDollar</span> <span class="o">&lt;-</span> <span class="o">-</span><span class="n">lsp</span><span class="o">$</span><span class="n">maxLoss</span> <span class="o">/</span> <span class="n">lsp</span><span class="o">$</span><span class="n">f</span>
</span></span><span class="line"><span class="cl">  <span class="n">maxfDollar</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span> <span class="n">fDollar</span><span class="nf">[is.finite</span><span class="p">(</span><span class="n">fDollar</span><span class="p">)</span><span class="n">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">den</span> <span class="o">&lt;-</span> <span class="n">maxfDollar</span> <span class="o">/</span> <span class="n">fDollar</span> <span class="o">*</span> <span class="n">margin</span>
</span></span><span class="line"><span class="cl">  <span class="n">den[</span><span class="o">!</span><span class="nf">is.finite</span><span class="p">(</span><span class="n">den</span><span class="p">)</span><span class="n">]</span>  <span class="o">&lt;-</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">eqPct</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">maxfDollar</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">den</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">max.units</span> <span class="o">&lt;-</span> <span class="n">eqPct</span> <span class="o">*</span> <span class="n">equity</span> <span class="o">/</span> <span class="n">fDollar</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span><span class="p">(</span><span class="n">max.units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">data</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>               <span class="c1"># Multiple strategy data</span>
</span></span><span class="line"><span class="cl"><span class="n">initEq</span> <span class="o">&lt;-</span> <span class="m">100000</span>         <span class="c1"># Initial equity</span>
</span></span><span class="line"><span class="cl"><span class="n">margin</span> <span class="o">&lt;-</span> <span class="o">-</span><span class="n">port</span><span class="o">$</span><span class="n">maxLoss</span>  <span class="c1"># Margin amounts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">opt</span> <span class="o">&lt;-</span> <span class="nf">optimalf</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>    <span class="c1"># Optimize portfolio</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span><span class="o">$</span><span class="n">f</span> <span class="o">&lt;-</span> <span class="n">opt</span><span class="o">$</span><span class="n">f</span>          <span class="c1"># Assign optimal f values to lsp object</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Units to trade</span>
</span></span><span class="line"><span class="cl"><span class="n">fUnits</span> <span class="o">&lt;-</span> <span class="n">initEq</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">port</span><span class="o">$</span><span class="n">maxLoss</span><span class="o">/</span><span class="n">port</span><span class="o">$</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># unconstrained</span>
</span></span><span class="line"><span class="cl"><span class="n">mUnits</span> <span class="o">&lt;-</span> <span class="nf">maxUnits</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">initEq</span><span class="p">)</span> <span class="c1"># margin-constrained</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Equity needed to trade at f values</span>
</span></span><span class="line"><span class="cl"><span class="nf">sum</span><span class="p">(</span><span class="n">fUnits</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span>  <span class="c1"># unconstrained</span>
</span></span><span class="line"><span class="cl"><span class="nf">sum</span><span class="p">(</span><span class="n">mUnits</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span>  <span class="c1"># margin-constrained</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Implied f values based on maximum units</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span><span class="o">$</span><span class="n">f</span> <span class="o">&lt;-</span> <span class="n">mUnits</span><span class="o">*-</span><span class="n">port</span><span class="o">$</span><span class="n">maxLoss</span><span class="o">/</span><span class="n">initEq</span>
</span></span><span class="line"><span class="cl"><span class="nf">GHPR</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>  <span class="c1"># 1.209931</span>
</span></span></code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/Examples/" rel="tag">Examples</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/LSPM/" rel="tag">LSPM</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "foss-trading" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH…" value="" name="q" aria-label="SEARCH…">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://blog.fosstrading.com/">
	</form>
</div>
<link href="//cdn-images.mailchimp.com/embedcode/classic-071822.css" rel="stylesheet" type="text/css">
<style type="text/css">
#mc_embed_signup{background:#fff; clear:left; font:12px Helvetica,Arial,sans-serif;}
 
</style>
<div id="mc_embed_signup">
    <form action="https://fosstrading.us9.list-manage.com/subscribe/post?u=3b596c57e89d8db5b99daf4ff&amp;id=85bd253834&amp;f_id=00fb1ce1f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_self">
        <div id="mc_embed_signup_scroll">
        <h2>Subscribe to email updates</h2>
        <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
<div class="mc-field-group">
<label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
</label>
<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required>
<span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
</div>
<div class="mc-field-group">
<label for="mce-FNAME">First Name </label>
<input type="text" value="" name="FNAME" class="" id="mce-FNAME">
<span id="mce-FNAME-HELPERTEXT" class="helper_text"></span>
</div>
<div class="mc-field-group">
<label for="mce-LNAME">Last Name </label>
<input type="text" value="" name="LNAME" class="" id="mce-LNAME">
<span id="mce-LNAME-HELPERTEXT" class="helper_text"></span>
</div>
<div class="mc-field-group input-group">
    <strong>Interests </strong>
    <ul><li>
    <input type="checkbox" value="1" name="group[53492][1]" id="mce-group[53492]-53492-0" checked>
    <label for="mce-group[53492]-53492-0">R package releases</label>
</li>
<li>
    <input type="checkbox" value="2" name="group[53492][2]" id="mce-group[53492]-53492-1" checked>
    <label for="mce-group[53492]-53492-1">Everything else</label>
</li>
</ul>
    <span id="mce-group[53492]-HELPERTEXT" class="helper_text"></span>
</div>
<div id="mce-responses" class="clear foot">
<div class="response" id="mce-error-response" style="display:none"></div>
<div class="response" id="mce-success-response" style="display:none"></div>
</div>    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3b596c57e89d8db5b99daf4ff_85bd253834" tabindex="-1" value=""></div>
        <div class="optionalParent">
            <div class="clear foot">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
                <p class="brandingLogo"><a href="http://eepurl.com/ijAV-n" title="Mailchimp - email marketing made easy and fun"><img src="https://eep.io/mc-cdn-images/template_images/branding_logo_text_dark_dtp.svg"></a></p>
            </div>
        </div>
    </div>
</form>
</div>


<div>
    <a title="CSI Data" href="https://www.csicheckout.com/cgi-bin/ua_order_form_nw.pl?referrer=JU" target="_blank">
      <img class="csi-banner" src="/csi-banner.jpg" width="160" height="312">
    </a>
    <p>
</div>

<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2023/06/running-timebase-in-docker/">Running TimeBase in Docker</a></li>
			<li class="widget__item"><a class="widget__link" href="/2023/06/streaming-data-with-timebase/">Streaming Market Data with TimeBase</a></li>
			<li class="widget__item"><a class="widget__link" href="/2023/05/getsymbols-rebooted/">getSymbols Rebooted</a></li>
			<li class="widget__item"><a class="widget__link" href="/2023/04/xts-0-13-1-on-cran/">xts_0.13.1 on CRAN</a></li>
			<li class="widget__item"><a class="widget__link" href="/2023/04/quantmod-0-4-22-on-cran/">quantmod_0.4.22 on CRAN</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/search/label/API/" title="API">API</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Code/" title="Code">Code</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/DEoptim/" title="DEoptim">DEoptim</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Data/" title="Data">Data</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Drawdown/" title="Drawdown">Drawdown</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Events/" title="Events">Events</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Examples/" title="Examples">Examples</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Excel/" title="Excel">Excel</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Historical-Data/" title="Historical Data">Historical Data</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/IBrokers/" title="IBrokers">IBrokers</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Interactive-Brokers/" title="Interactive Brokers">Interactive Brokers</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/LSPM/" title="LSPM">LSPM</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/PortfolioAnalytics/" title="PortfolioAnalytics">PortfolioAnalytics</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/R/" title="R">R</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Releases/" title="Releases">Releases</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/Reviews/" title="Reviews">Reviews</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/TTR/" title="TTR">TTR</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/TimeBase/" title="TimeBase">TimeBase</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/blotter/" title="blotter">blotter</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/quantmod/" title="quantmod">quantmod</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/quantstrat/" title="quantstrat">quantstrat</a>
		<a class="widget-taglist__link widget__link btn" href="/search/label/xts/" title="xts">xts</a>
	</div>
</div><div>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-7427704313601198"
       data-ad-slot="6372007789"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 FOSS Trading.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>