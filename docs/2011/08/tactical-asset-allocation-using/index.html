<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Tactical asset allocation using quantstrat - FOSS Trading</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="Tactical asset allocation using quantstrat" />
<meta property="og:description" content="As promised in the introduction to quantstrat, here is an example strategy. I thought I&rsquo;d start with the obligatory tactial asset allocation (TAA) strategy. This post will replicate the strategy in the post, tactical asset allocation using blotter.
The &ldquo;faber&rdquo; demo in the quanstrat package contains a TAA strategy but it uses a slightly different approach than the code we&rsquo;re trying to replicate. There are two major differences:
  The blotter TAA code initiates a position at the first observation where the close is above the SMA." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.fosstrading.com/2011/08/tactical-asset-allocation-using/" />
<meta property="article:published_time" content="2011-08-23T20:55:00-05:00" />
<meta property="article:modified_time" content="2011-08-23T20:55:00-05:00" />

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/fosstrading.css"><link rel="stylesheet" href="/syntax.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-3314405-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    <script data-ad-client="ca-pub-7427704313601198" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="FOSS Trading" rel="home">
				<div class="logo__title">FOSS Trading</div>
				<div class="logo__tagline">Algorithmic Trading with Free Open Source Software</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Blog</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/page/disclosures/">
				
				<span class="menu__text">Disclosures</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/page/enterprise/">
				
				<span class="menu__text">For Enterprise</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tactical asset allocation using quantstrat</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2011-08-23T20:55:00-05:00">August 23, 2011</time></div></div>
		</header><div class="content post__content clearfix">
			<p>As promised in the <a href="http://blog.fosstrading.com/2011/08/introduction-to-quantstrat.html">introduction to quantstrat</a>, here is an example strategy.  I thought I&rsquo;d start with the obligatory tactial asset allocation (TAA) strategy.  This post will replicate the strategy in the post, <a href="http://blog.fosstrading.com/2009/11/tactical-asset-allocation-using-blotter.html">tactical asset allocation using blotter</a>.</p>
<p>The &ldquo;faber&rdquo; demo in the quanstrat package contains a TAA strategy but it uses a slightly different approach than the code we&rsquo;re trying to replicate.  There are two major differences:</p>
<ol>
<li>
<p>The blotter TAA code initiates a position at the first observation where the close is above the SMA.  The demo only initiates a position when the close <em>crosses</em> the SMA to the upside.</p>
<p>For example, assume the close is above the SMA at the beginning of the sample.  The demo has to wait for the close to drop below the SMA and then cross above it before taking a position; the blotter TAA code initiates a position on the first observation.</p>
</li>
<li>
<p>The blotter TAA code calculates order size based on total account equity (as stored in the UnitSize object).  The demo always uses an order size of 1,000 shares, regardless of total account value (in case you&rsquo;re wondering, yes, capital/equity-aware order sizing is on the to-do list).</p>
</li>
</ol>
<p>We need to make a few changes to the demo(faber) code to make it work more like the blotter TAA post.  First, we change the add.signal calls to use sigCrossover instead of sigComparison.  This allows us to create an order on the first observation, rather than wait for a crossover.</p>
<p>Next, we need to change the first call to add.rule (the entry rule).  sigComparison will be TRUE for every period where the close is above the SMA and we don&rsquo;t want to buy 1000 shares every period, so we need to tell ruleSignal to use the max position order sizing function.  We do this by adding osFUN=osMaxPos to the list of arguments passed to ruleSignal.</p>
<p>Finally, we need to set the position limits for each instrument.  We do this via two calls to addPosLimit (one for each symbol) and we set the maximum position to 1000 shares and the minimum position to 0 shares.</p>
<p>The modified code is below and even includes some simple evaluation of the results at no extra charge.  The tradeStats function has a ton more columns; I&rsquo;ve only selected a few to make the output more readable.  Feel free to tinker.</p>
<p>NOTE: I wrote this code using the latest quantmod, xts, and zoo from CRAN; and the latest blotter, FinancialInstrument, and quantstrat from R-Forge.</p>
<p># This code is a slight modification of the quantstrat &ldquo;faber&rdquo; demo, intended to replicate <br>
# <a href="http://blog.fosstrading.com/2009/11/tactical-asset-allocation-using-blotter.html">http://blog.fosstrading.com/2009/11/tactical-asset-allocation-using-blotter.html</a> <br>
# Uncomment the line below to install the latest packages on R-Forge:<br>
#install.packages(c(&ldquo;quantstrat&rdquo;,&ldquo;blotter&rdquo;,&ldquo;FinancialInstrument&rdquo;), repos=&rdquo;<a href="http://r-forge.r-project.org/">http://r-forge.r-project.org</a>&quot;)</p>
<p>require(quantstrat)</p>
<p>require(PerformanceAnalytics)</p>
<p># Set initial values</p>
<p>initDate &lt;- &ldquo;2002-07-31&rdquo;</p>
<p>endDate &lt;- &ldquo;2009-10-31&rdquo;</p>
<p>initEq &lt;- 100000</p>
<p># Pull Yahoo Finance data</p>
<p>symbols &lt;- c(&ldquo;IEF&rdquo;, &ldquo;SPY&rdquo;)</p>
<p>getSymbols(symbols, from=initDate, to=endDate, index.class=c(&ldquo;POSIXt&rdquo;,&ldquo;POSIXct&rdquo;))</p>
<p># adjust for splits/dividends (comment to replicate blotter example)</p>
<p>#IEF &lt;- adjustOHLC(IEF, use.Adjusted=TRUE)</p>
<p>#SPY &lt;- adjustOHLC(SPY, use.Adjusted=TRUE)</p>
<p># convert to monthly</p>
<p>IEF &lt;- to.monthly(IEF, indexAt=&quot;endof&rdquo;)</p>
<p>SPY &lt;- to.monthly(SPY, indexAt=&quot;endof&rdquo;)</p>
<p># Set up instruments with FinancialInstruments package</p>
<p>currency(&ldquo;USD&rdquo;)</p>
<p>for(symbol in symbols) {</p>
<p>  stock(symbol, currency=&quot;USD&rdquo;, multiplier=1)</p>
<p>}</p>
<p># Delete portfolio, account, and order book if they already exist</p>
<p>suppressWarnings(rm(&ldquo;account.faber&rdquo;,&ldquo;portfolio.faber&rdquo;,pos=.blotter))</p>
<p>suppressWarnings(rm(&ldquo;order_book.faber&rdquo;,pos=.strategy))</p>
<p># Initialize portfolio and account</p>
<p>initPortf(&ldquo;faber&rdquo;, symbols=symbols, initDate=initDate)</p>
<p>initAcct(&ldquo;faber&rdquo;, portfolios=&quot;faber&rdquo;, initDate=initDate, initEq=initEq)</p>
<p>initOrders(portfolio=&quot;faber&rdquo;, initDate=initDate)</p>
<p># Initialize a strategy object</p>
<p>stratFaber &lt;- strategy(&ldquo;faber&rdquo;)</p>
<p># Add the 10-month SMA indicator</p>
<p>stratFaber &lt;- add.indicator(strategy=stratFaber, name=&quot;SMA&rdquo;,</p>
<p>  arguments=list(x=quote(Cl(mktdata)), n=10), label=&quot;SMA10&rdquo;)</p>
<p># There are two signals:</p>
<p># The first is when monthly price crosses over the 10-month SMA</p>
<p>stratFaber &lt;- add.signal(stratFaber, name=&quot;sigComparison&rdquo;,</p>
<p>  arguments=list(columns=c(&ldquo;Close&rdquo;,&ldquo;SMA10&rdquo;),relationship=&quot;gte&rdquo;), label=&quot;Cl.gt.SMA&rdquo;)</p>
<p># The second is when the monthly price crosses under the 10-month SMA</p>
<p>stratFaber &lt;- add.signal(stratFaber, name=&quot;sigComparison&rdquo;,</p>
<p>  arguments=list(columns=c(&ldquo;Close&rdquo;,&ldquo;SMA10&rdquo;),relationship=&quot;lt&rdquo;), label=&quot;Cl.lt.SMA&rdquo;)</p>
<p># There are two rules:</p>
<p># The first is to buy when the price crosses above the SMA</p>
<p>stratFaber &lt;- add.rule(stratFaber, name=&quot;ruleSignal&rdquo;,</p>
<p>  arguments=list(sigcol=&quot;Cl.gt.SMA&rdquo;, sigval=TRUE, orderqty=1000, ordertype=&quot;market&rdquo;,</p>
<p>  orderside=&quot;long&rdquo;, pricemethod=&quot;market&rdquo;, TxnFees=-5, osFUN=osMaxPos), type=&quot;enter&rdquo;, path.dep=TRUE)</p>
<p># The second is to sell when the price crosses below the SMA</p>
<p>stratFaber &lt;- add.rule(stratFaber, name=&quot;ruleSignal&rdquo;,</p>
<p>  arguments=list(sigcol=&quot;Cl.lt.SMA&rdquo;, sigval=TRUE, orderqty=&quot;all&rdquo;, ordertype=&quot;market&rdquo;,</p>
<p>  orderside=&quot;long&rdquo;, pricemethod=&quot;market&rdquo;, TxnFees=-5), type=&quot;exit&rdquo;, path.dep=TRUE)</p>
<p># Set position limits so we don&rsquo;t add to the position every month Close &gt; SMA10</p>
<p>addPosLimit(&ldquo;faber&rdquo;, &ldquo;SPY&rdquo;, timestamp=initDate, maxpos=1000, minpos=0)</p>
<p>addPosLimit(&ldquo;faber&rdquo;, &ldquo;IEF&rdquo;, timestamp=initDate, maxpos=1000, minpos=0)</p>
<p># Process the indicators and generate trades</p>
<p>out &lt;- try(applyStrategy(strategy=stratFaber, portfolios=&quot;faber&rdquo;))</p>
<p>updatePortf(&ldquo;faber&rdquo;)</p>
<p># Evaluate results</p>
<p>portRet &lt;- PortfReturns(&ldquo;faber&rdquo;)</p>
<p>portRet$Total &lt;- rowSums(portRet, na.rm=TRUE)</p>
<p>charts.PerformanceSummary(portRet$Total)</p>
<p>tradeStats(&ldquo;faber&rdquo;)[,c(&ldquo;Symbol&rdquo;,&ldquo;Num.Trades&rdquo;,&ldquo;Net.Trading.PL&rdquo;,&ldquo;Max.Drawdown&rdquo;)]</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/examples/" rel="tag">Examples</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/code/" rel="tag">Code</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/quantstrat/" rel="tag">quantstrat</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<div class="authorbox__header">
		<span class="authorbox__name">About Joshua Ulrich</span>
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/2011/08/introduction-to-quantstrat-comments/" rel="prev">
			<span class="post-nav__caption">«&thinsp;Previous</span>
			<p class="post-nav__post-title">Introduction to quantstrat</p>
		</a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/2011/08/tactical-asset-allocation-using-comments/" rel="next">
			<span class="post-nav__caption">Next&thinsp;»</span>
			<p class="post-nav__post-title">Tactical asset allocation using quantstrat</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q" aria-label="SEARCH...">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://www.fosstrading.com/" />
	</form>
</div><div>
    <a title="CSI Data" href="https://www.csicheckout.com/cgi-bin/ua_order_form_nw.pl?referrer=JU" target="_blank">
      <img class="csi-banner" src="/csi-banner.jpg" width="160" height="312">
    </a>
    <p>
</div>

<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2020/03/quantmod04-16-on-cran/">quantmod_0.4-16 on CRAN</a></li>
			<li class="widget__item"><a class="widget__link" href="/2019/10/microbenchmark14-7-on-cran/">microbenchmark_1.4-7 on CRAN</a></li>
			<li class="widget__item"><a class="widget__link" href="/2019/03/quantmod04-14-on-cran/">quantmod_0.4-14 on CRAN</a></li>
			<li class="widget__item"><a class="widget__link" href="/2018/11/xts-011-2-on-cran/">xts 0.11-2 on CRAN</a></li>
			<li class="widget__item"><a class="widget__link" href="/2018/09/xts-011-1-on-cran/">xts 0.11-1 on CRAN</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/api/" title="API">API</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/blotter/" title="blotter">blotter</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/code/" title="Code">Code</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/data/" title="Data">Data</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/deoptim/" title="DEoptim">DEoptim</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/drawdown/" title="Drawdown">Drawdown</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/events/" title="Events">Events</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/examples/" title="Examples">Examples</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/excel/" title="Excel">Excel</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/historical-data/" title="HIstorical Data">HIstorical Data</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/ibrokers/" title="IBrokers">IBrokers</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/interactive-brokers/" title="Interactive Brokers">Interactive Brokers</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/lspm/" title="LSPM">LSPM</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/portfolioanalytics/" title="PortfolioAnalytics">PortfolioAnalytics</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/quantmod/" title="quantmod">quantmod</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/quantstrat/" title="quantstrat">quantstrat</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/r/" title="R">R</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/releases/" title="Releases">Releases</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/reviews/" title="Reviews">Reviews</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/ttr/" title="TTR">TTR</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/xts/" title="xts">xts</a>
	</div>
</div><div>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-7427704313601198"
       data-ad-slot="6372007789"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 FOSS Trading.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>
